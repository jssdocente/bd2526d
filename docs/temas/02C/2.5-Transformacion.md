# **2.5. Transformaci√≥n del modelo ER a MR**

üëâ **Pasos**

Una vez conocido el modelo conceptual entidad-relaci√≥n y el modelo l√≥gico relacional, vamos a estudiar como transformar y pasar de uno a otro. Para ello, seguiremos los siguientes pasos:

1. Las entidades pasan a ser tablas
2. Los atributos pasar a ser columnas
3. Los atributos identificadores pasar a ser claves primarias.
4. Los atributos de las relaciones pasan a columnas detr√°s de las claves ajenas
5. Las relaciones, dependiendo de la cardinalidad, pasar√°n a ser claves ajenas y/o tablas.

## Atributos

Conviene recordar que dentro de una tabla, no se puede repetir el nombre de ning√∫n atributo, pero s√≠ en tablas diferentes.

Algunos profesionales prefieren que no se repitan los identificadores entre diferentes tablas de una misma BD, aunque es cierto que las herramientas ORM de generaci√≥n de modelos f√≠sicos a partir de definici√≥n de clases u objetos suelen nombrar todas las claves primarias como `id` o `_id`.

En cuanto a los atributos **compuestos**, se separan como atributos individuales dentro de la tabla, pudi√©ndoles poner el prefijo del atributo compuesto o el propio nombre del atributo si no da pie a confusi√≥n.

Para los atributos **derivados**, dependiendo del caso, bien no se a√±aden como atributo (ya que se obtendr√°n a partir de los datos de las relaciones), o bien se renombra el atributo para almacenar el dato en crudo sobre el cual se realiza el c√°lculo necesario.

![](images/04atributos.png "Transformaci√≥n de atributos"){ align="right" width="40%"}

Transformaci√≥n de atributos

Por ejemplo, si partimos de un sencillo modelo ER de un cliente, su transformaci√≥n al modelo relacional ser√≠a la siguiente:

`**CLIENTE** (dni, nombre, calle, numPiso, ciudad, fnac)`<br>
`¬∑ PK: (dni)`

Destacar que no hemos puesto el nombre del atributo compuesto, sino cada uno de sus atributos, y adem√°s, hemos renombrado `numero` a `numPiso` para evitar confusiones con otras entidades; respecto al atributo derivado edad, lo hemos cambiado por la fecha de nacimiento.

Respecto a los atributos **multivaluados**, derivan en una relaci√≥n uno a muchos (1:N), tal como veremos a continuaci√≥n.

### Claves compuestas

Normalmente, cada entidad tendr√° un atributo identificador que traduciremos en una clave primaria. Pero puede darse el caso que una entidad tenga una clave compuesta, o tenga marcados dos atributos identificadores (en este caso, uno ser√° la clave primaria y el otro ser√° una clave alternativa que marcaremos como √∫nica).

Por ejemplo, el siguiente diagrama representa un aula que se identifica mediante una clave compuesta:

![](images/04claves-compuestas.png "Clave primaria compuesta vs claves candidatas"){ align="left" width="55%"}

`**AULA** (edificio, numSala, numAsientos)`<br>
`¬∑ PK: (edificio, numSala)`

Sin embargo, tambi√©n podemos tener un empleado con dos atributos identificadores:

`**EMPLEADO** (codigo, nif, nombre, salario)`<br>
`¬∑ PK: (codigo)`<br>
`¬∑ UK: (nif)`<br>


## Transformaci√≥n de Relaciones

Al transformar las relaciones, dependiendo de la cardinalidad deberemos colocar la clave ajena en un lugar u otro.

### 1:N

La clave primaria de la entidad con cardinalidad m√°xima a 1 se incluye en la entidad con cardinalidad m√°xima N como clave ajena.

![](images/04relaciones1n.png "Transformaci√≥n de relaci√≥n 1:N"){ align="right" width="40%"}

`**A** (a0, a1, b0*)`<br>
`¬∑ PK: (a0)   ¬∑ FK: (b0) ‚Üí B`<br>

`**B** (b0, b1)`<br>
`¬∑ PK: (b0)`

De esta manera, tenemos que dado un registro en A, tendremos uno en B. Y dado un B, podemos tener muchos en A, cumpliendo la cardinalidad de uno a muchos.

!!! example "Ejemplo 2: Relaci√≥n 1:N. Personas y tel√©fonos"

    Por ejemplo, si tenemos un modelo donde, en vez de un atributo multivaluado, hemos creado una entidad para modelar que una persona puede tener muchos tel√©fonos:

    ![](images/04ejemplo1n.png "Ejemplo de relaci√≥n 1:N"){ align="left" width="30%"}

    Si aplicamos la transformaci√≥n reci√©n vista, obtenemos el siguiente esquema l√≥gico:

    `**PERSONA** (dni, nombre, direccion)`
    `¬∑ PK: (dni)`<br><br>
    `**TELEFONO** (numero, propio, dni*)`
    `¬∑ PK: (numero)`<br>
    `¬∑ FK: (dni) ‚Üí PERSONA`<br>

    Conviene recordar que la clave ajena ser√° la clave primaria que nos hemos traido desde la entidad con cardinalidad m√°xima a 1 (en este caso, llevamos la clave primaria de `PERSONA` a `TELEFONO`), de manera que el atributo `TELEFONO.dni` representa la relaci√≥n `TENER`.

    Las claves ajenas se colocan tras los atributos de cada tabla (en este caso, detr√°s de `numero` y `propio`), y normalmente, se nombran con el mismo nombre de la clave primaria. Si diera pie a confusi√≥n, es recomendable renombrarla pudiendo como sufijo el nombre de la tabla.

    Finalmente, si quisi√©ramos generar el diagrama relacional, obtendr√≠amos una gr√°fico similar al siguiente, donde se puede ver como desde `TELEFONO.dni` se conecta con `PERSONA.dni`:

    <figure markdown="span">
        <img src="images/04ejemplo1n-mr.png" width="80%">
        <figcaption>Esquema relacional en ERDPlus</figcaption>
    </figure>


> üí° Recordad la regla de integridad referencial del modelo relacional, donde cada valor de la clave ajena debe coincidir con un valor existente de la clave primaria a la que referencia (o ser nulo). De esta manera, no podemos tener un dni en la tabla TELEFONO que no exista previamente en la tabla PERSONA.


<div class="grid cards" markdown>

   - `PERSONA`
       
       | dni | nombre | direccion |
       | --- | --- | --- |
       | 11111111A | Pedro Casas | Calle Mayor, 1 |
       | 22222222B | Laura Garc√≠a | Avda Libertad, 33 |
       | 33333333C | Mireia Vidal | Paseo de la Estaci√≥n, 5 |
       
   - `TELEFONO`
       
       | numero | propio | dni`*` |
       | --- | --- | --- |
       | 636111111 | true | 22222222B |
       | 686222222 | true | 11111111A |
       | 666333333 | false | 11111111A |
       | 666444444 | true |  |

</div>

!!! success "Renombrando claves ajenas"

    Aunque es muy com√∫n que el nombre del atributo que hace de clave ajena coincida con la clave primaria a la que apunta, podemos renombrarla y ponerle un nombre que facilite su comprensi√≥n.

    En el caso de la tabla `TELEFONO`, el campo `dni` hace referencia al titular del tel√©fono, no es que un tel√©fono tenga un dni. Podr√≠amos haber modelado la tabla renombrando el `TELEFONO.dni` como `TELEFONO.propietario` dando un valor sem√°ntico al atributo:

    `**TELEFONO** (numero, propio, propietario*)`<br>
    `¬∑ PK: (numero)`<br>
    `¬∑ FK: (propietario) ‚Üí PERSONA`<br>

    Lo que s√≠ es obligatorio es que los dominios de las claves ajenas y las claves primarias coincidan.

!!! tip "Atributos multivaluados"

    Cuando tenemos un atributo multivaluado, √©ste se mapea en una relaci√≥n separada.

    Podemos crear una nueva tabla con un c√≥digo o atributo identificador para cada registro y a√±adir una clave ajena a modo de relaci√≥n 1:N.

    ![](images/04atributos-multivaluado.png "Atributo multivaluado"){ align="right" width="30%"}

    As√≠ pues, si tenemos un empleado que tiene muchos tel√©fonos mediante un atributo, generaremos dos tablas:

    `**EMPLEADO** (nif, nombre)`<br>
    `¬∑ PK: (nif)`
    <br>

    `**TELEFONO** (numero, dni*)`<br>
    `¬∑ PK: (numero)`<br>
    `¬∑ FK: (dni) ‚Üí EMPLEADO`<br>

    Si fuera un valor que pudiese compartirse entre varios empleados, como pudiera ser que un empleado tiene muchos cargos, y ese mismo cargo lo pueden tener varios empleados (pero no nos interesa a priori modelarlo conceptualmente como una entidad), podr√≠amos crear una clave primaria compuesta:

    `**CARGO** (cargo, dni*)`<br>
    `¬∑ PK: (cargo, dni)`<br>
    `¬∑ FK: (dni) ‚Üí EMPLEADO`<br>

--- 

### Transformar relaci√≥n 1:1

En este caso, la clave ajena se pone en cualquier entidad y se a√±ade como clave alternativa/√∫nica (`UK`).

![](images/04relaciones11.png "Transformaci√≥n de relaci√≥n 1:1"){ align="right" width="40%"}

Transformaci√≥n de relaci√≥n 1:1

As√≠ pues, una posible soluci√≥n ser√≠a llevar la clave ajena a A:

`**A** (a0, a1, b0*)`<br>
`¬∑ PK: (a0)`<br>
`¬∑ FK: (b0) ‚Üí B`<br>
`¬∑ UK: (b0)`<br>

`**B** (b0, b1)`
`¬∑ PK: (b0)`<br>

Al hacer que el atributo que es clave ajena sea clave √∫nica, restringimos que dicho valor no se pueda repetir.

Y la otra posible soluci√≥n ser√≠a llevar la clave ajena a B:

`**A** (a0, a1)`
`¬∑ PK: (a0)`<br>

`**B** (b0, b1, a0*)`<br>
`¬∑ PK: (b0)`<br>
`¬∑ FK: (a0) ‚Üí A`<br>
`¬∑ UK: (a0)`<br>

![](images/04ejemplo11.png "Ejemplo de relaci√≥n 1:1"){ align="right" width="30%"}

Vamos a poner otro ejemplo. En este caso, tenemos la relaci√≥n existente entre un veh√≠culo y el empleado que lo conduce en una empresa, dando lugar a una relaci√≥n 1:1 (f√≠jate como en este caso, hemos renombrado la clave ajena a `dniEmpleado` para facilitar la compresi√≥n):

`**EMPLEADO** (dni, nombre, direcci√≥n)`<br>
`¬∑ PK: (dni)`<br><br>
`**VEHICULO** (matr√≠cula, marca, modelo)`<br>
`¬∑ PK: (matr√≠cula)`<br>
`¬∑ UK: (dniEmpleado)`<br>
`¬∑ FK: (dniEmpleado) ‚Üí EMPLEADO`<br>

!!! question "¬øSabr√≠as...?"

    ¬øSabr√≠as crear otra soluci√≥n donde la clave ajena estuviera en la entidad `EMPLEADO`?  
    A continuaci√≥n, rellena las dos tablas con datos y comprueba si la relaci√≥n entre ambas entidades es 1:N o 1:1.


### Transformaci√≥n de relaci√≥n N:M

En el caso de las relaciones muchos a muchos, la relaci√≥n se traduce en una nueva tabla, cuya clave primaria se compone de las claves primarias referenciadas, y cada clave primaria es una clave ajena.

![](images/04relacionesnm.png "Transformaci√≥n de relaci√≥n N:M"){ align="right" width="60%"}

Transformaci√≥n de relaci√≥n N:M

`**A** (a0, a1)`<br>
`¬∑ PK: (a0)`<br>

`**B** (b0, b1)`
`¬∑ PK: (b0)`<br>

`**R** (a0*, b0*)`<br>
`¬∑ PK: (a0, b0)`<br>
`¬∑ FK: (a0) ‚Üí A`<br>
`¬∑ FK: (b0) ‚Üí B`<br>

Para este ejemplo, tenemos una empresa de transportes, donde un conductor conduce varios autobuses, y luego un autobus lo conducen varios conductores en diferentes trayectos, dando lugar a una relaci√≥n muchos a muchos, donde en la relaci√≥n a√±adimos el atributo `trayecto`:

![](images/04ejemplonm.png "Ejemplo de relaci√≥n N:M"){ align="left" width="30%"}

`**CONDUCTOR** (dni, nombre, experiencia)`<br>
`¬∑ PK: (dni)`<br>

`**AUTOBUS** (matricula, categoria)`<br>
`¬∑ PK: (matricula)`<br>

`**CONDUCIR** (dni*, matricula*, trayecto)`<br>
`¬∑ PK: (dni, matricula)`<br>
`¬∑ FK: (dni) ‚Üí CONDUCTOR`<br>
`¬∑ FK: (matricula) ‚Üí AUTOBUS`<br>

<br>
<br>
<br>

!!! tip "El orden importa"

    Cuando pasamos una relaci√≥n uno a muchos o muchos a muchos de un modelo ER a un modelo relacional, primero crearemos las tablas que no tienen claves ajenas.

    En este caso, empezaremos por `CONDUCTOR` y `AUTOBUS`, definiendo sus claves primarias y atributos.

    A continuaci√≥n, crearemos la/s tabla/s que contiene claves ajenas a las tablas ya creadas, esto es, la tabla `CONDUCIR` que apunta a `CONDUCTOR` y `AUTOBUS`.


En este caso, el diagrama del modelo relacional se traduce en tres tablas conectadas, colocando el atributo de la relaci√≥n en la nueva tabla `CONDUCIR`. Destacar como la tabla tiene una clave primaria compuesta, donde de cada parte de la clave sale una clave ajena a cada una de las tablas que relaciona:

<figure markdown="span">
  <img src="images/04ejemplonm-mr.png" width="60%">
  <figcaption>Esquema relacional en ERDPlus</figcaption>
</figure>


Y comprobamos con datos c√≥mo s√≠ se cumplen las cardinalidades:

<div class="grid cards" markdown>

- `AUTOBUS`
    
    | matricula`*` | categoria |
    | --- | --- |
    | 1111ABC | normal |
    | 2222BCD | larga distancia |
    | 3333DEF | larga distancia |
    
- `CONDUCTOR`
    
    | nif`*` | nombre | experiencia |
    | --- | --- | --- |
    | 11111111A | Andr√©s Checa | 1 |
    | 22222222B | Jos√© Escrig | 2 |
    | 33333333B | Marina Fern√°ndez | 3 |
    
- `CONDUCIR`
    
    | nif`*` | matricula`*` | trayecto |
    | --- | --- | --- |
    | 11111111A | 1111ABC | A |
    | 22222222B | 1111ABC | B |
    | 11111111A | 3333DEF | C |

</div>


#### N:M con dimensi√≥n temporal

Si la relaci√≥n tiene atributos de tipo fecha, ser√° necesario incluir al menos uno en la clave primaria.

Supongamos una empresa de alquiler de veh√≠culos, donde tenemos que un cliente puede alquilar el mismo veh√≠culo en fechas diferentes, o alquilar diferentes veh√≠culos. Claramente, un veh√≠culo lo pueden alquilar diferentes clientes en fechas diferentes. Para ello, creamos una relaci√≥n muchos a muchos, colocando la fecha de inicio y de finalizaci√≥n del alquiler en la propia relaci√≥n.

<figure markdown="span">
  <img src="images/04ejemplonm-fecha.png" width="90%">
  <figcaption>Relaci√≥n N:M con dimensi√≥n temporal</figcaption>
</figure>

Al crear el modelo relacional, tendremos las dos tablas de las entidades relacionadas:

`**CLIENTE** (dni, nombre)`<br>
`¬∑ PK: (dni)`

`**VEHICULO** (matricula, kms)`<br>
`¬∑ PK: (matricula)`

Y la tabla que las relaciona con el atributo de fecha de inicio como parte de la clave primaria (de este modo, el cliente A puede alquilar el veh√≠culo X en d√≠as diferentes):

`**ALQUILAR** (dni*, matricula*, finicio, ffin)`<br>
`¬∑ PK: (dni, matricula, finicio)`<br>
`¬∑ FK: (dni) ‚Üí CLIENTE`<br>
`¬∑ FK: (matricula) ‚Üí VEHICULO`<br>